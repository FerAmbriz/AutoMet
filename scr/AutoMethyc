#!/bin/bash

#============================= Defect parameters ============================#
thr=4
norm="False"
filtro="False"
genome="hg19"
depth=20
quality=30
read_fastq="Paired"
#============================= Input Parameters ============================#
arr=()
while [[ $# -gt 0 ]]; do
	opt="$1"
	shift;
	current_arg="$1"
	case "$opt" in
"-h"|"--help"      ) echo '''
AutoMethyc version 0.0.4-beta
Usage
	AutoMethyc [options]
Options
	-i --input		Folder with fastq
	-o --output		Output location
	-r --ref		Folder with references
Optional arguments
	-t --threads		Number of threads (default=4)
	-n --normal		Folder with fastq of normals (default=False)
	-g --genome		Reference genome (default=hg19)
		other genomes:
			{hg38, hg19, hg18, hg17, hg16, mm39, mm10, mm9, mm8, mm7}
	-f --filtro		File with regions of interest (default=False)
	-d --depth		Minimum depth to consider (default=20)
	-q --quality		Minimum quality (default=30)
''';  exit 1;;
"-i"|"--input"      ) input="$1"; arr+=( "-i" "$1"); shift;;
"-o"|"--output"      ) output="$1"; arr+=("-o" "$1"); shift;;
"-r"|"--reference"      ) ref="$1"; arr+=("-r" "$1"); shift;;
"-f"|"--filtro"      ) filtro="$1"; arr+=("-f" "$1"); shift;;
"-t"|"--threads"      ) thr="$1"; arr+=("-t" "$1") shift;;
"-n"|"--normal"      ) norm="$1"; arr+=("-n" "$1"); shift;;
"-g"|"--genome"       ) genome="$1"; arr+=("-g" "$1"); shift;;
"-q"|"--quality"       ) quality="$1"; arr+=("-q" "$1"); shift;;
"-d"|"--depth"       ) depth="$1"; arr+=("-d" "$1"); shift;;
"--read"       ) read_fastq="$1"; arr+=("--read" "$1"); shift;;
	esac
done
ref_folder=${ref%/*}
#============================= Presentation ============================#
figlet AutoMethyc
echo Version 0.0.5-beta
echo Universidad Nacional Autonoma de Mexico
echo '#============================Parameters==============================#'
echo 'input		|' $input
echo 'output		|' $output
echo 'reference	|'	$ref
echo 'bed		|' $filtro
echo 'threads		|' $thr
echo 'normal		|' $norm
echo 'genome		|' $genome
echo 'depth		|' $depth
echo 'quality		|' $quality
echo 'read		|' $read_fastq
echo '#===================================================================#'
echo -e " Automethyc ${arr[@]} \n input,$input \n output,$output \n reference,$ref \n bed,$filtro \n threads,$thr \n normal,$norm \n genome,$genome \n depth,$depth \n quaility,$quality \n" > $output/command_options.txt

#============================= Pipeline flow ============================#
start=`date +%s`

mkdir $output/CSV
mkdir $output/HTML
mkdir $output/Bismark
mkdir $output/HTML/Bismark_report
mkdir $output/VCF

if [ "$norm" = "False" ]; then
	if [ "$filtro" = "False" ]; then
		echo '=================== Without normals and filter ======================'
		#Bismark
		BuclePipeline $input $output $ref_folder $thr $quality $read_fastq samples

		# Descomprime y filtrado por profundidad
		DepthCord $output/Bismark/samples/bedGraph $output/CSV $depth

		# Construye merge
		MergeCord $output/Bismark/samples/bedGraph $output/CSV 'Sample'

		Annot_gene $output/CSV/merge.csv $genome $output/CSV $thr
		
		Filter $output/CSV/merge.csv $output/CSV/anotate_bed.csv $output/CSV/
		Oncoprint $output/CSV/Filtered.csv $output/CSV/

		multiqc $output/Bismark/samples/fastq_trimmed/*
		mv multiqc* $output/HTML

		WebScrapping $output/CSV/Oncoprint.csv $genome $output/CSV False

		fastqc_extract $output/Bismark/samples/fastq_trimmed $output/CSV

		RevelioHaplotype $output/Bismark/samples/aligned $ref $output/VCF $thr
		HTML_report $output $output/HTML False True
	else
		echo '================= Without normals and with filter ====================='
		BuclePipeline $input $output $ref_folder $thr $quality $read_fastq samples
		# Filtrado por profundidad
		DepthCord $output/Bismark/samples/bedGraph $output/CSV $depth
		# descomprime y renombra los archivos por ID
		#rename $output/results/06_bedGraph
		# Construcción del merge
		MergeCord $output/Bismark/samples/bedGraph $output/CSV 'Sample'
		Annot_gene $filtro $genome $output/CSV $thr
		# Aplicacion de filtros
		Filter $output/CSV/merge.csv $output/CSV/anotate_bed.csv $output/CSV
		Oncoprint $output/CSV/Filtered.csv $output/CSV

		multiqc $output/Bismark/samples/fastq_trimmed/*
		mv multiqc* $output/HTML

		CountUF $output/CSV/merge.csv $output/CSV/Filtered.csv $output/CSV
		WebScrapping $output/CSV/Oncoprint.csv $genome $output/CSV False

		fastqc_extract $output/Bismark/samples/fastq_trimmed $output/CSV

		RevelioHaplotype $output/Bismark/samples/aligned $ref $output/VCF $thr

		HTML_report $output $output/HTML False True
	fi
else
	if [ "$filtro" = "False" ]; then
		echo '==================== With normals and without filter ==================='
		echo '------------------------Normal Samples----------------------------------'
		BuclePipeline $norm $output $ref_folder $thr $quality $read_fastq normals
		# Filtrado por profundidad
		DepthCord $output/Bismark/normals/bedGraph $output/Bismark/normals $depth
		# descomprime y renombra los archivos por ID
		#rename $output/norm/results/06_bedGraph
		# Construcción del merge
		MergeCord $output/Bismark/normals/bedGraph $output/Bismark/normals 'Normal'		
		multiqc $output/Bismark/normals/fastq_trimmed/*

		mv multiqc_report.html $output/HTML/multiqc_report_normals.html
		mv multiqc_data $output/HTML/multiqc_data_normals


		echo '----------------------------Samples----------------------------------'
		BuclePipeline $input $output $ref_folder $thr $quality $read_fastq samples
		# Filtrado por profundidad
		DepthCord $output/Bismark/samples/bedGraph $output/Bismark/samples $depth

		#rename $output/samples/results/06_bedGraph
		MergeCord $output/Bismark/samples/bedGraph $output/Bismark/samples 'Sample'

		echo 'Joining in one file the samples and normals'
				
		awk '(NR == 1) || (FNR > 1)' $output/Bismark/normals/merge.csv $output/Bismark/samples/merge.csv > $output/CSV/merge.csv
		awk '(NR == 1) || (FNR > 1)' $output/Bismark/normals/CountUF_depth.csv $output/Bismark/samples/CountUF_depth.csv > $output/CSV/CountUF_depth.csv

		echo 'Done merge samples and normals'
 
		Annot_gene $output/CSV/merge.csv $genome $output/CSV $thr
		# Aplicacion de filtros
		Filter $output/CSV/merge.csv $output/CSV/anotate_bed.csv $output/CSV
		Oncoprint $output/CSV/Filtered.csv $output/CSV

		multiqc $output/Bismark/samples/fastq_trimmed/*
		mv multiqc_report.html $output/HTML/multiqc_report_samples.html
		mv multiqc_data $output/HTML/multiqc_data_samples

		mv $output/Bismark/normals/results_html/* $output/HTML/Bismark_report
		mv $output/Bismark/samples/results_html/* $output/HTML/Bismark_report

		fastqc_extract $output/Bismark/normals/fastq_trimmed $output/Bismark/normals
		fastqc_extract $output/Bismark/samples/fastq_trimmed $output/Bismark/samples
		awk '(NR == 1) || (FNR > 1)' $output/Bismark/normals/fastqc_merge.csv $output/Bismark/samples/fastqc_merge.csv > $output/CSV/fastqc_merge.csv

		Norm $output/CSV/Oncoprint.csv $output/CSV/OncoprintPromedio.csv $output/CSV
		PCA $output/CSV/OncoprintNorm.csv $output/CSV

		WebScrapping $output/CSV/Oncoprint.csv $genome $output/CSV False
		boxplot $output/CSV/OncoprintNorm.csv $output/CSV True $output/CSV/OncoprintMeanNorm.csv


		RevelioHaplotype $output/Bismark/normals/results/aligned $ref $output/VCF $thr
		RevelioHaplotype $output/Bismark/samples/results/aligned $ref $output/VCF $thr

		HTML_report $output $output/HTML True True
	else
		echo '==================== With normals and with filter ==================='
		echo '-------------------------- Normal Samples ---------------------------'
		BuclePipeline $norm $output $ref_folder $thr $quality $read_fastq normals
		# Filtrado por profundidad
		DepthCord $output/Bismark/normals/bedGraph $output/Bismark/normals $depth

		# descomprime y renombra los archivos por ID
		#rename $output/norm/results/06_bedGraph
		# Construcción del merge
		MergeCord $output/Bismark/normals/bedGraph $output/Bismark/normals 'Normal'

		multiqc $output/Bismark/normals/fastq_trimmed/*
		mv multiqc_report.html $output/HTML/multiqc_report_normals.html
		mv multiqc_data $output/HTML/multiqc_data_normals


		echo '----------------------------Samples--------------------------------'
		BuclePipeline $input $output $ref_folder $thr $quality $read_fastq samples
		
		# Filtrado por profundidad
		DepthCord $output/Bismark/samples/bedGraph $output/Bismark/samples $depth
		
		#rename $output/samples/results/06_bedGraph
		MergeCord $output/Bismark/samples/bedGraph $output/Bismark/samples 'Sample'

		echo 'Joining in one file the samples and normals'
		
		awk '(NR == 1) || (FNR > 1)' $output/Bismark/normals/merge.csv $output/Bismark/samples/merge.csv > $output/CSV/merge.csv
		awk '(NR == 1) || (FNR > 1)' $output/Bismark/normals/CountUF_depth.csv $output/Bismark/samples/CountUF_depth.csv > $output/CSV/CountUF_depth.csv

		Annot_gene $filtro $genome $output/CSV $thr
		Filter $output/CSV/merge.csv $output/CSV/anotate_bed.csv $output/CSV
		Oncoprint $output/CSV/Filtered.csv $output/CSV/

		multiqc $output/Bismark/samples/fastq_trimmed/*
		mv multiqc_report.html $output/HTML/multiqc_report_samples.html
		mv multiqc_data $output/HTML/multiqc_data_samples
				
		fastqc_extract $output/Bismark/normals/fastq_trimmed $output/Bismark/normals
		fastqc_extract $output/Bismark/samples/fastq_trimmed $output/Bismark/samples
		awk '(NR == 1) || (FNR > 1)' $output/Bismark/normals/fastqc_merge.csv $output/Bismark/samples/fastqc_merge.csv > $output/CSV/fastqc_merge.csv

		Norm $output/CSV/Oncoprint.csv $output/CSV/OncoprintPromedio.csv $output/CSV
		PCA $output/CSV/OncoprintNorm.csv $output/CSV
		CountUF $output/CSV/merge.csv $output/CSV/Filtered.csv $output/CSV
		WebScrapping $output/CSV/Oncoprint.csv $genome $output/CSV False
		boxplot $output/CSV/OncoprintNorm.csv $output/CSV True $output/CSV/OncoprintMeanNorm.csv

		RevelioHaplotype $output/Bismark/normals/results/aligned $ref $output/VCF $thr
		RevelioHaplotype $output/Bismark/samples/results/aligned $ref $output/VCF $thr

		HTML_report $output $output/HTML True True
	fi
fi

#Rscript /usr/bin/Oncoprint.R $output/OncoprintRellenado.csv $output/all_sites.png

#Rscript /usr/bin/OncoprintPromedio.R $output/OncoprintPromedio.csv $output/mean.png


echo 'Done Report HTML' 

end=`date +%s`
runtime=$((end-start))
echo 'run time = ' $runtime'(sec)'

echo '=========================== AutoMethyc Complete =============================='

#table_annovar.pl example/ex2.vcf humandb/ -buildver hg19 -out myanno -remove -protocol refGene,cytoBand,exac03,avsnp147,dbnsfp30a -operation g,r,f,f,f -nastring . -vcfinput -polish
